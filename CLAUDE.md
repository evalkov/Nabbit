# Nabbit — Developer Guide

## Project structure

Single-file pipeline: all code lives in `nabbit.py` (~4000 lines). No package structure.

### Key sections in nabbit.py (top to bottom)

1. **Imports & constants** (lines 1-55)
2. **FASTQ discovery** — `discover_fastqs()`: regex-based paired-end file matching
3. **Read processing** — `process_fastq_pair()`: merge, translate, quality filter
4. **CDR annotation** — `VHHAnnotator` class: IMGT motif-based FR/CDR annotation
5. **Clustering** — `cluster_by_cdr3()`, `detect_chimeras()`
6. **Clone tracking** — `track_clones()`: cross-round family frequency tracking
7. **Scoring** — `score_with_ablang()`: AbLang pseudo-perplexity
8. **Analysis** — `compute_enrichment()`, `compute_diversity()`, `compute_convergence()`, `compute_saturation()`, `compute_productivity_stats()`
9. **IgBLAST** — `run_igblast()`: V/D/J annotation via external binary
10. **PCA/Trees** — `compute_cluster_pca()`, `build_cdr3_tree()`
11. **Static plots** — `generate_plots()`: matplotlib PNG output
12. **Report** — `write_report()`: human-readable text summary
13. **Dashboard** — `generate_dashboard()` (~1300 lines): interactive HTML with Plotly
14. **Web server** — `NabbitHandler`, `start_server()`: built-in HTTP launcher UI
15. **main()** — CLI argument parsing and pipeline orchestration

## Key data structures

- `rounds_data: Dict[str, Counter]` — round name to protein sequence counter
- `all_stats: Dict[str, dict]` — per-round processing stats
- `top_df: DataFrame` — top N enriched sequences with per-round count/freq/cpm and fold/log2fc columns
- `annotations: DataFrame` — CDR annotations with FR1-4, CDR1-3, clone_id, clone_family, chimera flags
- `diversity_df: DataFrame` — Shannon, Simpson, Top1/Top10 dominance per round
- `clone_tracking: DataFrame` — family-level cross-round tracking
- `convergence_df: DataFrame` — Jaccard similarity between round pairs
- `saturation_df: DataFrame` — rarefaction data points per round

## Dashboard architecture

- Generated by `generate_dashboard()`, outputs a self-contained HTML file
- Uses Plotly via CDN (no local JS bundling)
- CSS theming with CSS variables (`--surface`, `--text`, `--accent`, etc.) for dark/light modes
- Pure JS for tabs, table sorting/filtering, theme toggle
- 5 tabs: Overview, Enrichment, Diversity, Clusters, Scoring (conditional)
- Each chart card has an expandable `<details>` figure legend
- CSS is in the `DASHBOARD_CSS` region at the top of `generate_dashboard()`
- JS is in the `DASHBOARD_JS` region

## Web server (--serve)

- `NabbitHandler` inner class with `_Handler` extending `BaseHTTPRequestHandler`
- Endpoints: `/api/scan`, `/api/locate`, `/api/browse`, `/api/run`, `/api/status/{id}`, `/api/dashboard/{id}`
- `/api/locate` uses `mdfind` (macOS) or `find` (Linux) to resolve drag-dropped filenames to a directory
- Pipeline runs are spawned as subprocesses; status polled via `/api/status/{run_id}`

## Running the pipeline for testing

```bash
# Generate synthetic test data
python generate_test_data.py

# Run pipeline on test data
python nabbit.py --fastq-dir test_fastqs --output-dir results_test --threads 4

# Start web UI
python nabbit.py --serve
```

## Conventions

- All Python code stays in `nabbit.py` — do not split into separate modules
- The pipeline must work with only core deps (numpy, pandas, scipy, matplotlib); optional features degrade gracefully
- Dashboard must be a single self-contained HTML file (no external assets except Plotly CDN)
- Use CSS variables for all colors in the dashboard to support dark/light themes
- Chart legends use `<details class="chart-legend">` elements; add one for any new chart
- Regex-based FASTQ discovery must handle standard Illumina naming; use `--sample-map` for edge cases
- Log with the `log` module logger, not print statements
- Test with `python3 -c "import py_compile; py_compile.compile('nabbit.py', doraise=True)"` after changes
